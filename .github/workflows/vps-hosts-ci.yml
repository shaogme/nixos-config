name: VPS Hosts Build and Test

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - 'docs/*'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================
  # 任务 0: 检查是否应该运行 (过滤自动更新提交)
  # ============================================================
  should-run:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check if triggered by auto-update
        id: check
        run: |
          # 检查 commit message 是否是自动更新产生的
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          if [[ "$COMMIT_MESSAGE" == *"chore: update flake.lock"* ]]; then
            echo "Skipping: triggered by auto-update commit"
            echo "should_run=false" >> $GITHUB_OUTPUT
          else
            echo "Running: normal commit"
            echo "should_run=true" >> $GITHUB_OUTPUT
          fi

  # ============================================================
  # 任务 1: 更新 VPS Hosts 的 lock 文件
  # ============================================================
  update-vps-locks:
    needs: should-run
    if: needs.should-run.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            download-buffer-size = 1073741824

      - name: Setup Cachix
        uses: cachix/cachix-action@v16
        with:
          name: chaotic-nyx
          skipPush: true

      # 更新所有 VPS host 的 flake.lock
      - name: Update VPS hosts flake.lock files
        run: |
          nix flake update --flake ./vps/hyperv
          nix flake update --flake ./vps/tohu

      # 上传更新后的 lock 文件作为 artifact
      - name: Upload updated flake.lock files
        uses: actions/upload-artifact@v4
        with:
          name: vps-flake-locks
          path: |
            vps/hyperv/flake.lock
            vps/tohu/flake.lock
          retention-days: 1

  # ============================================================
  # 任务 2: 静态构建检查 (确保能编译生成系统)
  # ============================================================
  check-build:
    needs: update-vps-locks
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        host: [hyperv, tohu]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download updated flake.lock files
        uses: actions/download-artifact@v4
        with:
          name: vps-flake-locks
          path: vps

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            download-buffer-size = 1073741824

      - name: Setup Cachix
        uses: cachix/cachix-action@v16
        with:
          name: chaotic-nyx
          skipPush: true

      - name: Build System Toplevel (${{ matrix.host }})
        # 这一步只编译不运行，确保语法和依赖没问题
        run: nix build ./vps/${{ matrix.host }}#nixosConfigurations.${{ matrix.host }}.config.system.build.toplevel

  # ============================================================
  # 任务 3: VM 集成测试
  # ============================================================
  vm-tests:
    needs: update-vps-locks
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        host: [hyperv, tohu]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download updated flake.lock files
        uses: actions/download-artifact@v4
        with:
          name: vps-flake-locks
          path: vps

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            download-buffer-size = 1073741824
            # 确保 Nix 知道我们可以用 KVM
            system-features = kvm big-parallel nixos-test

      - name: Setup Cachix
        uses: cachix/cachix-action@v16
        with:
          name: chaotic-nyx
          skipPush: true

      # 关键步骤：确保 Runner 能够使用硬件虚拟化加速
      - name: Enable KVM group perms
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          ls -la /dev/kvm

      - name: Run VM Test (${{ matrix.host }})
        run: |
          echo "Running VM test for host: ${{ matrix.host }}"
          nix build -L --print-build-logs ./vps/${{ matrix.host }}#nixosConfigurations.${{ matrix.host }}.config.system.build.vmTest

  # ============================================================
  # 任务 4: 聚合测试结果
  # ============================================================
  ci-success:
    needs: 
      - check-build
      - vm-tests
    runs-on: ubuntu-latest
    if: always()
    outputs:
      success: ${{ steps.check.outputs.success }}
    steps:
      - name: Check Status
        id: check
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "One or more jobs failed or were cancelled."
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "All VPS hosts tests passed."
          echo "success=true" >> $GITHUB_OUTPUT

  # ============================================================
  # 任务 5: 触发 flake.lock 更新 (仅在测试成功时)
  # ============================================================
  trigger-update-flake:
    needs: 
      - should-run
      - ci-success
    if: needs.should-run.outputs.should_run == 'true' && needs.ci-success.outputs.success == 'true'
    uses: ./.github/workflows/update-flake.yml
    secrets: inherit

