name: Sync No-Lock-Update to Pre-Release

on:
  push:
    branches:
      - no-lock-update
  workflow_dispatch:

jobs:
  sync-to-pre-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.PAT }}
          fetch-depth: 0

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            download-buffer-size = 1073741824
            extra-substituters = https://attic.xuyh0120.win/lantian https://cache.garnix.io
            extra-trusted-public-keys = lantian:EeAUQ+W+6r7EtwnmYjeVwx5kOGEBpjlBfPlzGlTNvHc= cache.garnix.io:CTFPyKSLcx5RMJKfLo5EEPUObbA78b0YQ2DTCJXqr9g=

      - name: Update Flake Locks
        uses: ./.github/actions/update-flake-locks

      - name: Sync to pre-release
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add updated locks
          git add .
          
          # Amend the current commit to include lock updates
          # logic: We want to modify the commit that is about to be synced.
          # Since we are on a detached head or branch, amending works locally.
          git commit --amend --no-edit
          
          # Force push to pre-release
          git push origin HEAD:pre-release --force
