name: Build and Test NixOS Configuration

on:
  pull_request:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - 'docs/*'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # 任务 1: 静态构建检查 (确保能编译生成系统)
  check-configuration:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        host: [tohu, hyperv]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            download-buffer-size = 1073741824

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: chaotic-nyx
          skipPush: true

      - name: Update flake.lock
        uses: ./.github/actions/update-locks

      - name: Build System Toplevel
        # 这一步只编译不运行，确保语法和依赖没问题
        run: nix build ./vps/${{ matrix.host }}#nixosConfigurations.${{ matrix.host }}.config.system.build.toplevel

  # 任务 2: 动态虚拟机测试 (运行 QEMU 验证服务启动)
  integration-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        host: [tohu, hyperv]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            download-buffer-size = 1073741824
            # 确保 Nix 知道我们可以用 KVM
            system-features = kvm big-parallel nixos-test

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: chaotic-nyx
          skipPush: true

      # 关键步骤：确保 Runner 能够使用硬件虚拟化加速
      # 如果没有这一步，虚拟机测试会极慢（纯软件模拟）
      - name: Enable KVM group perms
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          ls -la /dev/kvm

      - name: Run NixOS Integration Tests
        # 运行 Host Flake 中定义的 inline vmTest
        # --print-build-logs 非常重要，如果测试挂了，你能看到 Python 脚本的报错输出
        run: nix build -L --print-build-logs ./vps/${{ matrix.host }}#nixosConfigurations.${{ matrix.host }}.config.system.build.vmTest

  # 任务 3: 聚合测试结果 (用于 Branch Protection Rule)
  ci-success:
    needs: 
      - check-configuration
      - integration-tests
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check Status
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "One or more jobs failed or were cancelled."
            exit 1
          fi
          echo "All jobs passed."