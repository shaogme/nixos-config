name: Build and Test NixOS Configuration

on:
  pull_request:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - 'docs/*'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup-hosts:
    runs-on: ubuntu-latest
    outputs:
      hosts: ${{ steps.set-hosts.outputs.hosts }}
    steps:
      - uses: actions/checkout@v4
      - id: set-hosts
        run: echo "hosts=$(bash .github/scripts/get-hosts.sh)" >> $GITHUB_OUTPUT

  # ============================================================
  # 任务 2: Flake 语法和评估检查
  # ============================================================
  check-flake:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            extra-substituters = https://attic.xuyh0120.win/lantian https://cache.garnix.io
            extra-trusted-public-keys = lantian:EeAUQ+W+6r7EtwnmYjeVwx5kOGEBpjlBfPlzGlTNvHc= cache.garnix.io:CTFPyKSLcx5RMJKfLo5EEPUObbA78b0YQ2DTCJXqr9g=
            download-buffer-size = 1073741824

      # 检查所有 flake 的语法和评估
      - name: Check all flakes
        run: |
          nix flake check --no-build
          nix flake check --no-build ./core
          nix flake check --no-build ./extra/kernel/cachyos

  # ============================================================
  # 任务 3: VM 集成测试 (两种内核配置)
  # ============================================================
  vm-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        kernel: [xanmod, cachyos]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            extra-substituters = https://attic.xuyh0120.win/lantian https://cache.garnix.io
            extra-trusted-public-keys = lantian:EeAUQ+W+6r7EtwnmYjeVwx5kOGEBpjlBfPlzGlTNvHc= cache.garnix.io:CTFPyKSLcx5RMJKfLo5EEPUObbA78b0YQ2DTCJXqr9g=
            download-buffer-size = 1073741824
            # 确保 Nix 知道我们可以用 KVM
            system-features = kvm big-parallel nixos-test

      # 关键步骤：确保 Runner 能够使用硬件虚拟化加速
      - name: Enable KVM group perms
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          ls -la /dev/kvm

      # 运行对应内核的 VM 测试
      - name: Run VM Test (${{ matrix.kernel }})
        run: |
          echo "Running VM test for kernel: ${{ matrix.kernel }}"
          nix build -L --print-build-logs .#checks.x86_64-linux.kernel-${{ matrix.kernel }}

  # ============================================================
  # 任务 4: VPS 静态构建检查 (确保能编译生成系统)
  # ============================================================
  vps-check-build:
    runs-on: ubuntu-latest
    needs: setup-hosts
    strategy:
      fail-fast: false
      matrix:
        host: ${{ fromJson(needs.setup-hosts.outputs.hosts) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            extra-substituters = https://attic.xuyh0120.win/lantian https://cache.garnix.io
            extra-trusted-public-keys = lantian:EeAUQ+W+6r7EtwnmYjeVwx5kOGEBpjlBfPlzGlTNvHc= cache.garnix.io:CTFPyKSLcx5RMJKfLo5EEPUObbA78b0YQ2DTCJXqr9g=
            download-buffer-size = 1073741824

      - name: Build System Toplevel (${{ matrix.host }})
        # 这一步只编译不运行，确保语法和依赖没问题
        run: nix build ./vps/${{ matrix.host }}#nixosConfigurations.${{ matrix.host }}.config.system.build.toplevel

  # ============================================================
  # 任务 5: VPS VM 集成测试
  # ============================================================
  vps-vm-tests:
    runs-on: ubuntu-latest
    needs: setup-hosts
    strategy:
      fail-fast: false
      matrix:
        host: ${{ fromJson(needs.setup-hosts.outputs.hosts) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            extra-substituters = https://attic.xuyh0120.win/lantian https://cache.garnix.io
            extra-trusted-public-keys = lantian:EeAUQ+W+6r7EtwnmYjeVwx5kOGEBpjlBfPlzGlTNvHc= cache.garnix.io:CTFPyKSLcx5RMJKfLo5EEPUObbA78b0YQ2DTCJXqr9g=
            download-buffer-size = 1073741824
            # 确保 Nix 知道我们可以用 KVM
            system-features = kvm big-parallel nixos-test

      # 关键步骤：确保 Runner 能够使用硬件虚拟化加速
      - name: Enable KVM group perms
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          ls -la /dev/kvm

      - name: Run VM Test (${{ matrix.host }})
        run: |
          echo "Running VM test for host: ${{ matrix.host }}"
          nix build -L --print-build-logs ./vps/${{ matrix.host }}#nixosConfigurations.${{ matrix.host }}.config.system.build.vmTest

  # ============================================================
  # 任务 6: 聚合测试结果 (用于 Branch Protection Rule)
  # ============================================================
  ci-success:
    needs: 
      - check-flake
      - vm-tests
      - vps-check-build
      - vps-vm-tests
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check Status
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "One or more jobs failed or were cancelled."
            exit 1
          fi
          echo "All jobs passed."